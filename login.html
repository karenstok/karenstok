<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Toko Item Game</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="login-container">
        <div class="login-gradient">
            <div class="robux-logo-container">
                <svg width="120" height="120" viewBox="0 0 120 120">
                    <defs>
                        <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#FFA500;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path d="M 60 10 L 90 30 L 90 70 L 60 90 L 30 70 L 30 30 Z" fill="url(#goldGradient)" stroke="#FFA500" stroke-width="3"/>
                    <path d="M 60 25 L 80 40 L 80 65 L 60 80 L 40 65 L 40 40 Z" fill="#fff" stroke="#FFA500" stroke-width="2"/>
                    <rect x="50" y="50" width="20" height="20" rx="2" fill="url(#goldGradient)" transform="translate(-10 -10)"/>
                </svg>
            </div>
            
            <h1 class="login-title">Toko Item Game</h1>
            <p class="login-subtitle">Masuk dengan Username Roblox</p>
            
            <div class="login-card">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="usernameInput">Username Roblox</label>
                        <div class="input-with-icon">
                            <span class="material-symbols-outlined">person</span>
                            <input type="text" id="usernameInput" placeholder="Masukkan username kamu" required>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <div class="info-steps">
                            <div class="info-step">
                                <span class="material-symbols-outlined check-icon">check_circle</span>
                                <span>Pastikan username benar</span>
                            </div>
                            <div class="info-step">
                                <span class="material-symbols-outlined check-icon">check_circle</span>
                                <span>Tidak perlu password</span>
                            </div>
                            <div class="info-step">
                                <span class="material-symbols-outlined check-icon">check_circle</span>
                                <span>100% aman & terpercaya</span>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary" id="loginBtn">
                        <span id="loginBtnText">Masuk</span>
                        <div class="spinner" id="loginSpinner" style="display: none;"></div>
                    </button>
                </form>
            </div>
            
            <div class="security-badge">
                <span class="material-symbols-outlined">security</span>
                <span>Kami tidak pernah meminta password Roblox</span>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://uas-farisv1.vercel.app';

        async function verifyUsername(username) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/verify?username=${encodeURIComponent(username)}`);
                const data = await response.json();
                
                if (response.ok && data.valid) {
                    return {
                        valid: true,
                        username: data.username,
                        userId: data.userId,
                        displayName: data.displayName
                    };
                }
                
                return {
                    valid: false,
                    message: data.message || 'Username tidak ditemukan'
                };
            } catch (error) {
                return {
                    valid: false,
                    message: 'Gagal terhubung ke server. Cek koneksi internet kamu.'
                };
            }
        }

        async function fetchAvatar(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/avatar?userId=${userId}`);
                const data = await response.json();
                
                if (response.ok && data.success && data.avatarUrl) {
                    return data.avatarUrl;
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        function showAlert(message, type = 'info') {
            const colors = {
                success: '#4CAF50',
                error: '#F44336',
                info: '#2196F3'
            };
            
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${colors[type]};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 90%;
                text-align: center;
            `;
            alert.textContent = message;
            document.body.appendChild(alert);
            
            setTimeout(() => alert.remove(), 3000);
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput.value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginSpinner = document.getElementById('loginSpinner');
            
            if (!username) {
                showAlert('Username tidak boleh kosong', 'error');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtnText.style.display = 'none';
            loginSpinner.style.display = 'block';
            
            try {
                const result = await verifyUsername(username);
                
                if (result.valid) {
                    const avatarUrl = await fetchAvatar(result.userId);
                    
                    // Save to localStorage
                    localStorage.setItem('roblox_username', result.username);
                    localStorage.setItem('roblox_user_id', result.userId);
                    if (avatarUrl) {
                        localStorage.setItem('roblox_avatar_url', avatarUrl);
                    }
                    
                    showAlert('Login berhasil! Selamat datang ' + result.username, 'success');
                    setTimeout(() => {
                        window.location.href = 'home.html';
                    }, 500);
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Terjadi kesalahan. Silakan coba lagi.', 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtnText.style.display = 'block';
                loginSpinner.style.display = 'none';
            }
        });

        // Check if already logged in
        window.addEventListener('DOMContentLoaded', () => {
            const username = localStorage.getItem('roblox_username');
            if (username) {
                window.location.href = 'home.html';
            }
        });
    </script>
</body>
</html>
