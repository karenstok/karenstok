<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - Toko Item Game</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-header">
        <h1>Profil</h1>
    </div>

    <div class="profile-content-new">
        <div class="profile-header-card">
            <img id="profileAvatar" src="" alt="Avatar" class="profile-avatar">
            <h2 id="profileUsername"></h2>
            <div class="profile-badge">
                <span class="material-symbols-outlined">verified</span>
                <span>Akun Roblox Terverifikasi</span>
            </div>
            <div class="profile-id" id="profileId"></div>
        </div>

        <div class="profile-menu">
            <button class="profile-menu-item" onclick="refreshAvatar()">
                <div class="menu-icon">
                    <span class="material-symbols-outlined">refresh</span>
                </div>
                <div class="menu-text">
                    <div class="menu-title">Perbarui Avatar</div>
                    <div class="menu-subtitle">Sinkronkan dengan avatar Roblox</div>
                </div>
                <span class="material-symbols-outlined">chevron_right</span>
            </button>

            <button class="profile-menu-item" onclick="showAbout()">
                <div class="menu-icon">
                    <span class="material-symbols-outlined">info</span>
                </div>
                <div class="menu-text">
                    <div class="menu-title">Tentang Aplikasi</div>
                    <div class="menu-subtitle">Versi 1.0.0</div>
                </div>
                <span class="material-symbols-outlined">chevron_right</span>
            </button>
        </div>

        <button class="btn-logout" onclick="handleLogout()">
            <span class="material-symbols-outlined">logout</span>
            <span>Logout</span>
        </button>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="home.html" class="nav-item">
            <span class="material-symbols-outlined">shopping_bag</span>
            <span>Item</span>
        </a>
        <a href="pembayaran.html" class="nav-item">
            <span class="material-symbols-outlined">receipt</span>
            <span>Pembayaran</span>
        </a>
        <a href="profil.html" class="nav-item active">
            <span class="material-symbols-outlined">person</span>
            <span>Profil</span>
        </a>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button class="modal-close" onclick="closeModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://uas-farisv1.vercel.app';

        // Check login
        const username = localStorage.getItem('roblox_username');
        if (!username) {
            window.location.href = 'login.html';
        }

        function showAlert(message, type = 'info') {
            const colors = {
                success: '#4CAF50',
                error: '#F44336',
                info: '#2196F3'
            };
            
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${colors[type]};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 90%;
                text-align: center;
            `;
            alert.textContent = message;
            document.body.appendChild(alert);
            
            setTimeout(() => alert.remove(), 3000);
        }

        async function fetchAvatar(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/avatar?userId=${userId}`);
                const data = await response.json();
                
                if (response.ok && data.success && data.avatarUrl) {
                    return data.avatarUrl;
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        function updateProfile() {
            const username = localStorage.getItem('roblox_username');
            const userId = localStorage.getItem('roblox_user_id');
            const avatarUrl = localStorage.getItem('roblox_avatar_url');
            
            document.getElementById('profileUsername').textContent = username;
            document.getElementById('profileId').textContent = `ID: ${userId || 'N/A'}`;
            
            const profileAvatar = document.getElementById('profileAvatar');
            if (avatarUrl) {
                profileAvatar.src = avatarUrl;
            } else {
                profileAvatar.alt = username[0]?.toUpperCase() || 'U';
            }
        }

        async function refreshAvatar() {
            const userId = localStorage.getItem('roblox_user_id');
            if (!userId) return;
            
            showAlert('Memperbarui avatar...', 'info');
            const avatarUrl = await fetchAvatar(userId);
            
            if (avatarUrl) {
                localStorage.setItem('roblox_avatar_url', avatarUrl);
                showAlert('Avatar berhasil diperbarui!', 'success');
                updateProfile();
            } else {
                showAlert('Gagal memperbarui avatar', 'error');
            }
        }

        function showAbout() {
            showModal('Tentang Aplikasi', `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ðŸŽ®</div>
                    <h3>Toko Item Game</h3>
                    <p style="color: var(--text-secondary); margin: 8px 0;">Versi 1.0.0</p>
                    <p style="margin-top: 16px;">Aplikasi pembelian item game yang cepat, aman, dan terpercaya.</p>
                </div>
            `, `<button class="btn-primary" onclick="closeModal()">Tutup</button>`);
        }

        function handleLogout() {
            showModal('Konfirmasi Logout', `
                <p>Apakah kamu yakin ingin keluar?</p>
            `, `
                <button class="btn-outline" onclick="closeModal()" style="margin-right: 8px;">Batal</button>
                <button class="btn-logout" onclick="confirmLogout()">Logout</button>
            `);
        }

        function confirmLogout() {
            localStorage.clear();
            showAlert('Logout berhasil', 'success');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 500);
        }

        function showModal(title, body, footer) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modalFooter').innerHTML = footer;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

        // Initialize
        updateProfile();
    </script>
</body>
</html>
